<!-- jsfiddle : https://jsfiddle.net/t408gdkq/ -->

<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Murder Mystery</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <audio id="backgroundMusic" width="0" height="0" src="./Crime Music No CopyrightScary Murder Mystery BG Music No Copyright - Suspense & Mysterious Music.mp3" loop></audio>
    <audio id="endMusic" width="0" height="0" src="./SPOOKTOBER TRUMPET TUNES.mp3" loop></audio>
    
    <style>
        body {
        font-family: Arial, sans-serif;
        text-align: center;
        margin: 0;
        padding: 20px;
        background-color: #f0f0f0;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }

        h1, h2, h3 {
            color: #333;
        }
        
        input, button {
            margin: 10px 0;
            padding: 10px;
            width: 100%;
            box-sizing: border-box;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        ul {
            list-style-type: none;
            padding: 0;
        }
        
        li {
            margin: 5px 0;
        }
        
        #deathCode {
            font-size: 24px;
            font-weight: bold;
            letter-spacing: 3px;
            margin: 20px 0;
            padding: 10px;
            background-color: #f8f8f8;
            border-radius: 5px;
        }

        #codeInput {
            font-size: 20px;
            letter-spacing: 2px;
            text-align: center;
            width: 200px;
            margin: 10px auto;
            display: block;
        }

        .code-entry {
            margin: 20px 0;
        }

        .container:hover {
            transform: scale(1.02);
        }

        #chatMessages {
            background-color: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
        }


        .sent-message {
            text-align: right;
            color: #6a1b9a;
            margin: 5px 0;
            display: inline-block;
            max-width: 80%;
            word-wrap: break-word;
            padding: 10px;
            border-radius: 10px;
            background-color: #e1bee7;
        }

        .received-message {
            text-align: left;
            color: #c62828;
            margin: 5px 0;
            display: inline-block;
            max-width: 80%;
            word-wrap: break-word;
            padding: 10px;
            border-radius: 10px;
            background-color: #ffebee;
        }

        #coupleChat {
            width: calc(100% - 22px);
            padding: 10px;
            margin-top: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            transition: border-color 0.3s;
        }

        #coupleChat:focus {
            border-color: #4facfe;
            outline: none;
        }

        #torchButton {
            transition: all 0.3s ease;
        }

        #torchButton.torch-active {
            background-color: #ffff00;
            color: black;
            box-shadow: 0 0 10px rgba(255,255,0,0.7);
        }

        /* Style du modal */
        .modal {
            display: none; /* Masqué par défaut */
            position: fixed; /* Reste en place */
            z-index: 1; /* Au-dessus des autres éléments */
            left: 0;
            top: 0;
            width: 100%; /* Largeur complète */
            height: 100%; /* Hauteur complète */
            overflow: auto; /* Ajoute un défilement si nécessaire */
            background-color: rgb(0,0,0); /* Couleur de fond noir */
            background-color: rgba(0,0,0,0.4); /* Fond noir avec transparence */
        }

        /* Contenu du modal */
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto; /* 15% du haut et centré */
            padding: 20px;
            border: 1px solid #888;
            width: 80%; /* Largeur de 80% */
        }

        /* Bouton de fermeture */
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .button-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh; /* Prend toute la hauteur de la fenêtre */
        }

        .styled-button {
            background-color: #f30002; /* Utilisez la même couleur que l'autre bouton */
            color: #ffffff; /* Couleur du texte */
            border: none;
            padding: 15px 30px; /* Ajustez le padding selon vos besoins */
            font-size: 16px; /* Taille de la police */
            cursor: pointer;
            border-radius: 5px; /* Coins arrondis */
            transition: background-color 0.3s ease; /* Animation de transition */
        }

        .styled-button:hover {
            background-color: #d20000; /* Couleur au survol */
        }

        /* Styles pour mobile */
        @media (max-width: 600px) {
            .styled-button {
                font-size: 14px; /* Réduire la taille de la police sur mobile */
                padding: 10px 20px; /* Ajuster le padding sur mobile */
            }
        }

        /* Styles pour le header en dégradé */
        .gradient-header {
            position: relative; /* Nécessaire pour le positionnement du pseudo-élément */
            background: linear-gradient(to right, #800000, #4B0000, #660000, #8B0000, #000080, #000033, #002147, #1B0030);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent; /* Pour le texte */
            color: transparent; /* Valeur de secours */
        }

        .gradient-title {
            background: linear-gradient(to right, #4B0000, #800000, #A00000, #E60000, #FF0000);
            background-clip: text; /* Propriété standard */
            -webkit-background-clip: text; /* Préfixe pour les navigateurs basés sur WebKit */
            -webkit-text-fill-color: transparent; /* Préfixe pour les navigateurs basés sur WebKit */
            color: transparent; /* Valeur de secours pour les navigateurs qui ne supportent pas background-clip */
        }

        #deathCode {
            user-select: none;
        }
    </style>

</head>

<body>

    <div class="container">

        <!-- Bouton pour accéder au jeu -->
        <div id="accessPageButtonContainer" style="text-align: center; margin: 20px 0;">
            <button class="styled-button" onclick="pageAccess()">Accéder au jeu</button>
        </div>

        <!-- Page de saisie du pseudo -->
        <div id="accessPage" style="display: none;">
            <h1 class="gradient-title">Murder Mystery</h1>

            <div id="welcome">
                <input type="text" id="playerName" placeholder="Entrez votre pseudo">
                <button id="joinButton">Rejoindre</button>
            </div>


            <div id="gameInProgress" style="display: none;">
                <h2>Une partie est déjà en cours</h2>
                <p>Veuillez attendre qu'elle se termine pour rejoindre.</p>
            </div>


            <div id="waiting" style="display: none;">
                <h2>Joueurs en attente</h2>
                <ul id="playerList"></ul>
                <button id="readyButton">Prêt</button>
            </div>
        </div>


        <div id="countdown" style="display: none;">
            <h2>Démarrage du jeu dans <span id="timer">10</span> secondes</h2>
        </div>

        <div id="game" style="display: none;">

            <div id="roleDisplay" style="display: none;">
                <h2>Votre rôle : <span id="role"></span></h2>
                <!-- Autres éléments pour le rôle -->
            </div>

            <button id="deadButton">Se mettre mort</button>
            <button id="scanButton">Vérifier un mort</button>


            <div id="deathCodeDisplay" style="display: none;">
                <p>Votre code de mort :</p>
                <div id="deathCode" onpaste="return false"></div>
            </div>


            <div id="codeEntry" class="code-entry" style="display: none;">
                <input type="text" id="codeInput" maxlength="6" placeholder="Entrez le code">
                <button id="submitCode">Valider</button>
            </div>

            <div id="torchButton" style="display: none;">
                <button class="switch">Allumer la lampe</button>
            </div>

            <div id="coupleSection" style="display: none;">
                <div id="chatMessages"></div>
                <input type="text" id="coupleChat" placeholder="Envoyer un message">
            </div>

            <h3>Joueurs morts :</h3>
            <ul id="dead-players-list">
                <!-- La liste des joueurs morts sera insérée ici -->
            </ul>


            
            
    
            <div id="gameStatus" style="display: none;">
                <h2>Temps restant : <span id="remainingTime"></span></h2>
            </div>
        </div>

        <div id="gameOver" style="display: none;">
            <h2 class="gradient-header">Fin du jeu !</h2>
            <p id="gameOverMessage"></p>
            <button id="restartButton" class="styled-button" onclick="restartGame()">Rejouer</button>
        </div>
    </div>

    <!-- Pop-up Modal -->
    <div id="rulesModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>

            <h2 class="gradient-header">Règles du jeu Murder Mystery</h2>
            <p>
                Bienvenue dans Murder Mystery ! Voici comment le jeu fonctionne :
            </p>

            <h3 class="gradient-header"><u>Objectif du jeu </u></h3>
            <p>
                L'objectif est de découvrir qui est le(s) meurtrier(s) parmi les joueurs. Les joueurs peuvent avoir différents rôles (comme shérif, médecin, caméraman, couple), chacun avec ses propres capacités et objectifs. Le jeu se termine lorsque le meurtrier ou les innoncents sont morts ou lorsque le temps est écoulé.
            </p>

            <h3 class="gradient-header"><u>Règles de base </u></h3>
            <ul>
                <li>Chaque joueur reçoit un rôle secret au début du jeu.</li>
                <li>Les joueurs doivent interagir, poser des questions et rassembler des indices.</li>
                <li>Les joueurs peuvent "se mettre mort" pour simuler leur mort et créer des mystères.</li>
                <li>Les joueurs peuvent vérifier les codes des morts pour confirmer les décès.</li>
                <li>Le jeu se termine lorsque le meurtrier ou les innoncents sont morts ou que le temps est écoulé.</li>
                <li>Lorsque le temps est écoulé, le gagnant est désigné de manière aléatoire</li> 
            </ul>

            <h3 class="gradient-header"><u>Interdictions et obligations</u></h3>
                <li><b><font color="red">Interdiction</font></b> d'utiliser vos vrais noms et prénoms (pour Léo par exemple, il peut utiliser Diego ou pour Axel le nom de son daron <i>(ah bah nan il n'en a pas 🙃)</i>)</li>
                <li><b><font color="red">Interdiction</font></b> de rester par groupe de plus de 3 personnes</li>
                <li><b><font color="red">Interdiction</font></b> de rester plus de 15 secondes au même endroit</li> 
                <li><b><font color="red">Interdiction</font></b> de bouger une fois mis "prêt".</li>    
                <li><b><font color="red">Interdiction</font></b> de se mettre à côté d'un joueur avant de lancer une partie.</li>
                <li><b><font color="red">Interdiction</font></b> de partager son rôle durant la partie.</li>
                <li><b><font color="red">Interdiction</font></b> de se parler par message ailleurs que dans le chat du jeu. (pour le couple)</li>
                <li><b><font color="red">Interdiction</font></b> de se mettre dans le même groupe pour les personnes possédant les 2 armes (shérif + personnes qui a trouvé la seconde arme)</li>
                <li><b><font color="red">Interdiction</font></b> de dévoiler où se trouve la deuxième arme et d'utiliser l'arme durant la prochaine partie(personne qui l'a caché) </li>
                <li><b><font color="red">Interdiction</font></b> de prendre le téléphone d'une autre personne (sauf si elle est morte et pour rentrer le code)</li>
                <li><b><font color="red">Interdiction</font></b> de former des alliances (sauf pour le couple)</li>
                <li><b><font color="red">Interdiction</font></b> de faire semblant de rentrer le code (si le joueur mort n'a pas encore été mit dans la liste et que le joueur entrant le code est un meurtrier)</li>
                <li><b><font color="blue">Obligation</font></b> de garder son téléphone alumé en étant mort pour pouvoir rentrer les codes de mort </li>
                <li><b><font color="blue">Obligation</font></b> de rester allongé par terre quand on est mort et de ne pas bouger ni parler par la suite</li>
                <li><b><font color="blue">Obligation</font></b> de ne pas parler à une personne morte</li>
                

            <h3 class="gradient-header"><u>Comment jouer </u></h3>
            <p>
                1. Entrez votre pseudo et rejoignez le jeu.
                <br>
                2. Dispersez-vous dans la maison et mettez vous prêts à jouer.
                <br>
                3. Attendez que tous les joueurs soient prêts.
                <br>
                4. Suivez les instructions à l'écran et interagissez avec les autres joueurs.
                <br>
                5. Essayez de découvrir qui est le(s) meurtrier(s) ou tuer tout les innoncents sans vous faire remarquer avant que le temps ne soit écoulé.  
            </p>
            <p>
                Amusez-vous bien et bonne chance !
            </p>

        </div>
    </div>
    
    <script>
        let playerName;
        let players  = [];
        let readyPlayers = [];
        let role;
        let roles = {};
        let deadPlayers = [];
        let isDead = false;
        let gameStarted = false;
        let deathCode = '';
        let scannedDeadPlayers = [];  // Pour stocker uniquement les joueurs morts confirmés
        let couplePartner = null;
        const socket = io();
        const SUPPORTS_MEDIA_DEVICES = 'mediaDevices' in navigator;
        let coupleMessages = {}; // Stocker les messages par couple
        let torchState = {
            isActive: false,
            stream: null,
            track: null
        };
        let messageshown = false;

        document.addEventListener('visibilitychange', () => {
            if (document.hidden && torchState.isActive) {
                stopTorch();
            }
        });

        window.addEventListener('beforeunload', () => {
            if (torchState.isActive) {
                stopTorch();
            }
        });


        $('#welcome').hide();
        $('#game').hide();

        // Obtenir le modal
        const modal = document.getElementById("rulesModal");

        const music = document.getElementById('backgroundMusic');

        // Obtenir l'élément <span> qui ferme le modal
        const closeButton = document.getElementsByClassName("close-button")[0];

        // Fonction pour ouvrir le modal
        function openModal() {
            modal.style.display = "block";
        }

        // Lorsque l'utilisateur clique sur <span> (x), fermez le modal
        closeButton.onclick = function() {
            modal.style.display = "none";
        }

        // Lorsque l'utilisateur clique n'importe où en dehors du modal, fermez-le
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        // Ouvrir le modal dès que la page est chargée
        window.onload = function() {
            $('#accessPageButtonContainer').show();
        }

        function pageAccess() {
            $('#accessPageButtonContainer').hide();
            $('#accessPage').show();
            music.play();
            openModal();
        }

        // Écouter l'événement pour mettre à jour la liste des joueurs morts
        socket.on('update_dead_players', function(data) {
            const deadPlayers = data.dead_players;
            // Mettez à jour l'interface utilisateur avec la liste des joueurs morts
            const deadPlayersList = document.getElementById('dead-players-list'); // Assurez-vous d'avoir cet élément dans votre HTML
            deadPlayersList.innerHTML = ''; // Vider la liste actuelle
            deadPlayers.forEach(function(player) {
                const listItem = document.createElement('li');
                listItem.textContent = player; // Ajouter le joueur mort à la liste
                deadPlayersList.appendChild(listItem);
            });
        });


        // ----------------------------------------
        function toggleTorch() {
            if (!SUPPORTS_MEDIA_DEVICES) {
                showTorchError('Votre appareil ne supporte pas la lampe torche');
                return;
            }

            if (torchState.isActive) {
                stopTorch();
            } else {
                startTorch();
            }
        }


        function startTorch() {

            navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: 'environment',
                    advanced: [{ torch: true }]
                }
            }).then(stream => {
                const track = stream.getVideoTracks()[0];
                const capabilities = track.getCapabilities();

                if (!capabilities.torch) {
                    track.stop();
                    showTorchError('Lampe torche non disponible');
                    return;
                }

                torchState.stream = stream;
                torchState.track = track;
                torchState.isActive = true;

                track.applyConstraints({
                    advanced: [{ torch: true }]
                });

                updateTorchUI(true);
                navigator.vibrate(100);
            }).catch(handleTorchError);
        }


        function stopTorch() {
            if (!torchState.track) return;

            try {
                torchState.track.applyConstraints({
                    advanced: [{ torch: false }]
                });
                torchState.track.stop();
                torchState.stream.getTracks().forEach(track => track.stop());
                
                torchState.isActive = false;
                torchState.stream = null;
                torchState.track = null;

                updateTorchUI(false);
                navigator.vibrate(50);
            } catch (error) {
                console.error('Torch shutdown error:', error);
            }
        }


        function updateTorchUI(isActive) {
            const button = document.querySelector('.switch');
            button.textContent = isActive ? 'Éteindre la lampe' : 'Allumer la lampe';
            button.classList.toggle('torch-active', isActive);
        }


        function handleTorchError(error) {
            console.error('Torch error:', error);
            const errorMessages = {
                NotAllowedError: 'Accès refusé à la caméra',
                NotFoundError: 'Caméra non trouvée',
                NotReadableError: 'Caméra déjà utilisée',
                OverconstrainedError: 'Configuration non supportée'
            };
            showTorchError(errorMessages[error.name] || 'Erreur lampe torche');
        }


        function showTorchError(message) {
            alert(message);
            updateTorchUI(false);
        }


        // Fonction de vérification de compatibilité
        function isTorchSupported() {
            return 'mediaDevices' in navigator && 
                'getUserMedia' in navigator.mediaDevices;
        }


        // Initialisation
        $(document).ready(function() {

            // Function to check for available cameras
            function checkForCameras() {
                if (!SUPPORTS_MEDIA_DEVICES) {
                    return Promise.resolve([]); // Return an empty array if not supported
                }

                return navigator.mediaDevices.enumerateDevices()
                    .then(devices => devices.filter(device => device.kind === 'videoinput'))
                    .catch(error => {
                        return [];
                    });
            }

            // Function to initialize the torch button
            function initializeTorchButton(cameras) {
                if (cameras.length === 0 || !SUPPORTS_MEDIA_DEVICES) {
                    $('#torchButton').hide();
                } else {
                    $('#torchButton').show();
                }
            }
            
            // Main execution
            checkForCameras().then(cameras => {
                initializeTorchButton(cameras);
            });
        });


        // Ajouter un gestionnaire d'événements pour le bouton
        $('#torchButton').on('click', toggleTorch);
        // -------------------------------------------------

        // ----------------------------------------
        function initCoupleCommunication() {
            // Récupérer le partenaire du couple
            $.ajax({
                url: '/get_couple_partner',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ name: playerName }),
                success: function(data) {
                    console.log('g check sal batard');
                    couplePartner = data.partner;
                    if (couplePartner) {
                        $('#coupleSection').show();
                        startCoupleMessagePolling();
                    }
                }
            });
        }

        function startCoupleMessagePolling() {
            setInterval(function() {
                // Vérifier si le partenaire est toujours en vie
                $.ajax({
                    url: '/check_couple_partner_alive',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ name: playerName }),
                    success: function(data) {
                        if (!data.is_partner_alive && messageshown === false) {
                            messageshown = true;
                            // Partenaire mort
                            $('#chatMessages').append(`<div class="received-message">Ton QuoicouBebouDesÎlesCaïmansSucréAuSucreDesÎlesDeLaRéunionCrèmementCrèméÀLaCrèmeFouettementFouêtéAuFouet est mort</div>`);
                            return;
                        }

                        if (!data.is_partner_alive && isDead) {
                            $('#coupleSection').hide();
                            return;
                        }

                        // Récupérer les messages
                        $.ajax({
                            url: '/get_couple_messages',
                            method: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify({ name: playerName }),
                            success: function(messageData) {
                                messageData.messages.forEach(function(msg) {
                                    $('#chatMessages').append(`<div class="received-message">${msg.sender}: <br>${msg.message}</div><br>`);
                                });
                            }
                        });
                    }
                });
            }, 1000); // Toutes les secondes
        }

        $('#coupleChat').on('keypress', function(e) {
            if (e.which == 13) { // Touche Entrée
                const message = $(this).val();
                if (message.trim() !== '' && !isDead) {
                    $.ajax({
                        url: '/send_couple_message',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            sender: playerName,
                            message: message
                        }),
                        success: function() {
                            $('#chatMessages').append(`<div class="sent-message">${playerName}: <br>${message}</div><br>`);
                        }
                    });
                    $(this).val('');
                }
            }
        });

        //-------------------------------------------------


            // Modifier la fonction startGame pour initialiser la communication du couple
        function startGame() {
            $.ajax({
                url: '/start_game',
                method: 'POST',
                contentType: 'application/json', // Ajoutez ceci pour spécifier le type de contenu
                data: JSON.stringify({ name: playerName }), // Envoyez le nom du joueur
                success: function(data) {
                    roles = data
                    role = data.roles[playerName];
                    $('#countdown').hide();
                    $('#coupleSection').hide();
                    $('#role').text(role);
                    $('#game').show();

                    if (role === 'Couple') {
                        initCoupleCommunication();
                    }
                    // Arrêter la musique
                    const music = document.getElementById('backgroundMusic');
                    music.pause(); // Arrête la musique
                    music.currentTime = 0; // Remet à zéro la musique

                    startGameTimer();
                }  
        });
        }


        // Vérifier l'état du jeu au chargement de la page
        $(document).ready(function() {
            checkGameState();
        });


        function checkGameState() {
            $.ajax({
                url: '/game_state',
                method: 'GET',
                success: function(data) {
                    if (data.game_in_progress) {
                        $('#welcome').hide();
                        $('#gameInProgress').show();
                    } else {
                        $('#welcome').show();
                        $('#gameInProgress').hide();
                    }
                }
            });
        }


        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
        }


        function startGameTimer() {
            $('#gameStatus').show(); // Afficher l'état du jeu
            const timeLimit = 600; // 10 minutes en secondes
            let elapsedTime = 0;

            

            // Afficher les rôles pendant les 10 premières secondes
            $('#roleDisplay').show();
            const roleDisplayDuration = 10; // secondes

            // Masquer les rôles après 10 secondes
            setTimeout(function() {
                $('#roleDisplay').hide();
            }, roleDisplayDuration * 1000);

            const timer = setInterval(function() {
                elapsedTime++;
                const remainingTime = timeLimit - elapsedTime;
                $('#remainingTime').text(formatTime(remainingTime));

                // Afficher les rôles pendant les 20 dernières secondes
                if (remainingTime <= 20) {
                    $('#roleDisplay').show();
                }

                // Si le temps restant est écoulé
                if (remainingTime <= 0) {
                    clearInterval(timer);
                    endGame("Le temps est écoulé ! Le gagnant est choisi au hasard.");
                }
                checkGameEndConditions();
            }, 1000);
            gameStarted = true;
        }

        
        function generateDeathCode() {
            const characters = '0123456789AÀÁÂÃÄÅÆBÇCĆČDÈÉÊËEĒĖĘFGHIÌÍÎÏIĪJKLMNOÒÓÕÖØŌŒPQRSTUÙÚÛÜŪVWXYŸZ,;:!?./§&."(-_)=^$*£#{[|@]}';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }


        function startUpdateInterval() {
            updatePlayerList();
            setInterval(updatePlayerList, 1000);
        }


        $('#joinButton').click(function() {
            playerName = $('#playerName').val();
            if (playerName.trim() === "") {
                alert("Veuillez entrer un pseudo.");
                return;
            }
            $.ajax({
                url: '/join',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ name: playerName }),
                success: function(data) {
                    if (data.success) {
                        players = data.players;
                        $('#welcome').hide();
                        $('#waiting').show();
                        startUpdateInterval();
                    } else {
                        alert(data.message);
                        checkGameState();
                    }
                }
            });
        });


        $('#readyButton').click(function() {
            $.ajax({
                url: '/ready',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ name: playerName }),
                success: function(data) {
                    readyPlayers = data.ready_players;
                    $('#readyButton').prop('disabled', true);
                    $('#readyButton').text('En attente des autres joueurs...');
                    if (data.all_ready) {
                        startCountdown();
                    }
                }
            });
        });


        function updatePlayerList() {
            $.ajax({
                url: '/get_players',
                method: 'GET',
                success: function(data) {
                    players = data.players;
                    readyPlayers = data.ready_players;
                    deadPlayers = data.dead_players;
                    $('#playerList').empty();
                    const boutonPret = document.getElementById('readyButtonx');
                    if (players.length < 4) {
                        $('#readyButton').prop('disabled', true);
                    } else {
                        $('#readyButton').prop('disabled', readyPlayers.includes(playerName));
                    }
                    players.forEach(player => {
                        const readyStatus = readyPlayers.includes(player) ? ' (Prêt)' : '';
                        $('#playerList').append(`<li>${player}${readyStatus}</li>`);
                    });
                    $('#readyButton').prop('disabled', readyPlayers.includes(playerName));
                    
                    updateDeadList();
                    
                    if (data.all_ready && !gameStarted) {
                        startCountdown();
                    }

                }
            });
        }


        function updateDeadList() {
            $('#deadList').empty();
            scannedDeadPlayers.forEach(deadPlayer => {
                $('#deadList').append(`<li>${deadPlayer}</li>`);
            });
        }


        function startCountdown() {
            $('#waiting').hide();
            $('#countdown').show();
            let timeLeft = 10;
            $('#timer').text(timeLeft);
            const countdownInterval = setInterval(() => {
                timeLeft--;
                $('#timer').text(timeLeft);
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    startGame();
                }
            }, 1000);
        }


        function checkGameEndConditions() {
            const murderers = players.filter(p => roles[p] === "Meurtrier");
            const innocents = players.filter(p => roles[p] !== "Meurtrier");

            const murderersAlive = murderers.filter(p => !deadPlayers.includes(p));
            const innocentsAlive = innocents.filter(p => !deadPlayers.includes(p));

            console.log(murderers, innocents)

            // Vérifier si tous les meurtriers sont morts
            if (murderersAlive.length === 0 && gameStarted) {
                endGame("Les innocents ont gagné en éliminant tous les meurtriers !");
            }

            // Vérifier si tous les innocents sont morts
            if (innocentsAlive.length === 0 && gameStarted) {
                endGame("Les meurtriers ont gagné en éliminant tous les innocents !");
            }
        }


        function endGame(message) {
            $('#game').hide()
            $('#gameOver').show()
            $('#gameOverMessage').text(message)
            const endMusic= document.getElementById("endMusic")
            endMusic.play()
        }


        $('#deadButton').click(function() {
            deathCode = generateDeathCode();
            $.ajax({
                url: '/set_dead',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ name: playerName, code: deathCode }),
                success: function(data) {
                    isDead = true;
                    $('#deadButton').hide();
                    $('#scanButton').hide();
                    $('#deathCode').text(deathCode);
                    $('#deathCodeDisplay').show();
                }
            });
            $('#scanButton').hide();
            $('#codeEntry').hide();
        });

        $('#scanButton').click(function() {
            $('#codeEntry').show();
            $('#codeInput').focus();
        });

        $('#submitCode').click(function() {
            const enteredCode = $('#codeInput').val().toUpperCase();
            if (enteredCode.length !== 6) {
                alert("Le code doit contenir 6 caractères");
                return;
            }

            $.ajax({
                url: '/verify_dead',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ 
                    scanner: playerName, 
                    code: enteredCode 
                }),
                success: function(data) {
                    if (data.success) {
                        alert("Code valide ! Joueur mort confirmé.");
                        $('#codeInput').val('');
                        $('#codeEntry').hide();
                        updatePlayerList();
                    } else {
                        alert("Code invalide !");
                        $('#codeInput').val('');
                    }
                }
            });
        });

        // Gestion de l'entrée du code
        $('#codeInput').on('input', function() {
            this.value = this.value.toUpperCase();
        });

        let text = "Murder Mystery";
        let index = 0;
        let forward = true;
        let interval = 200;  // Vitesse de l'animation (en millisecondes)

        function updateTitle() {
        if (forward) {
            // Ajoute une lettre à chaque fois
            document.title = text.substring(0, index + 1);
            index++;
            if (index === text.length) {
            forward = false;  // Changer de direction quand tout le texte est affiché
            }
        } else {
            // Enlève une lettre à chaque fois
            document.title = text.substring(0, index);
            index--;
            if (index === 0) {
            forward = true;  // Recommence à afficher quand tout le texte est enlevé
            }
        }
        }

        setInterval(updateTitle, interval);

        function restartGame() {
            const endMusic = document.getElementById("endMusic")
            endMusic.pause()
            endMusic.currentTime = 0
            
            const music = document.getElementById("backgroundMusic")
            music.play()

            // Réinitialiser l'état de l'interface utilisateur
            $('#gameOver').hide();
            $('#accessPage').show();
            $('#playerName').val('');
            
            // Réinitialiser les variables de jeu si nécessaire
            players = [];
            readyPlayers = [];
            deadPlayers = [];
            scannedDeadPlayers = [];
            roles = {};
            deathCodes = {};
            gameStarted = false;
            isDead = false;

            // Optionnel : Réinitialiser le serveur si nécessaire
            $.ajax({
                url: '/reset_game', // Vous devrez créer cette route si nécessaire
                method: 'POST'
            });
        }
    </script>
    
</body>

</html>